pipeline {
    agent any

    tools {
        nodejs 'NodeJS-20'
    }

    environment {
        NODE_VERSION = '20'
        APP_NAME = 'recharge-earn-be'

        // Server
        PORT = '3000'
        NODE_ENV = 'test'

        // MongoDB
        MONGODB_URI = 'mongodb://localhost:27017/recharge-earn'

        // JWT
        JWT_SECRET = 'dummy-jwt-secret-for-ci'
        JWT_EXPIRES_IN = '7d'

        // Paystack
        PAYSTACK_SECRET_KEY = 'sk_test_xxx'
        PAYSTACK_PUBLIC_KEY = 'pk_test_xxx'
        PAYSTACK_WEBHOOK_SECRET = 'whsec_xxx'

        // Data Up API
        DATA_UP_BASE_URL = 'https://api.dataup.com'
        DATA_UP_IDENTIFIER = 'your_identifier'
        DATA_UP_PASSWORD = 'your_password'

        // App URL
        APP_URL = 'http://localhost:3000'

        // SMTP
        SMTP_HOST = 'smtp.gmail.com'
        SMTP_PORT = '587'
        SMTP_SECURE = 'false'
        SMTP_USER = 'ci-dummy@gmail.com'
        SMTP_PASS = 'your-app-password'
        SMTP_FROM_NAME = 'Recharge Earn'
    }

    options {
        timeout(time: 15, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh "node --version || (echo 'Node not found' && exit 1)"
                sh 'npm install'
            }
        }

        stage('Test') {
            steps {
                sh 'npm test'
            }
        }

        stage('Build') {
            steps {
                sh 'npm run build'
            }
        }

        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: 'dist/**/*', fingerprint: true
            }
        }
    }

    post {
        success {
            echo 'Build completed successfully.'
        }
        failure {
            echo 'Build failed.'
        }
        always {
            cleanWs(deleteDirs: true, patterns: [[pattern: 'node_modules', type: 'INCLUDE']])
        }
    }
}
